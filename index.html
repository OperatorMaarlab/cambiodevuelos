<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Visualizador de cambios · Maarlab</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet"/>
<style>
  :root{
    --card:#fff; --ink:#0b2a5a; --sub:#475569; --border:#d7ddea;
    --accent:#15c79b; --accent2:#2ca9ff;
    --oldA:#ffc7d0; --oldB:#ff9aa9; --oldBorder:#7f1d1d;  /* rojo más oscuro */
    --newA:#cfeedd; --newB:#aee6c8; --newBorder:#14532d;  /* verde más oscuro */
    --muted:#eef2f7;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font:15px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,system-ui,sans-serif;
    background:#0a223f;
  }
  /* Fondo Maarlab oscuro con velo */
  body::before{content:"";position:fixed;inset:0;z-index:-2;background:linear-gradient(135deg,var(--accent),var(--accent2))}
  body::after{content:"";position:fixed;inset:0;z-index:-1;background:linear-gradient(to bottom,rgba(255,255,255,.14),rgba(255,255,255,.22) 45%,rgba(255,255,255,.70))}
  .wrap{max-width:1240px;margin:0 auto;padding:16px}

  /* Barra superior */
  .bar{position:sticky;top:0;background:#ffffff;border-bottom:1px solid var(--border);z-index:30}
  .barInner{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:1240px;margin:0 auto;padding:10px 16px}
  .brandTitle{font:700 18px/1 Poppins,-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,system-ui;letter-spacing:.2px}
  .sep{height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .logoBoxTiny{width:28px;height:28px;border:1px solid var(--border);border-radius:8px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .logoBoxTiny img{max-width:100%;max-height:100%;object-fit:contain;display:block}

  .grid2{display:grid;gap:16px}
  @media(min-width:1100px){.grid2{grid-template-columns:2fr 1fr}}

  .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:16px}
  .btn{border:0;border-radius:12px;padding:10px 14px;color:#0b2a5a;background:linear-gradient(135deg,var(--accent),var(--accent2));cursor:pointer;font-weight:600}
  .chip{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .chip button{padding:6px 10px;border:0;background:#f1f5f9;cursor:pointer;color:#0b2a5a}
  .chip button.active{background:#fff}
  label{font-size:12px;color:#334155;display:block;margin-bottom:8px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff;color:#0b2a5a}
  input[placeholder]{text-transform:uppercase}
  input.invalid{border-color:#ef4444!important;background:#fff1f2}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .tiny{font-size:11px;color:#64748b}
  h2{font:700 16px/1.2 Poppins,-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,system-ui;margin:0 0 6px}

  /* Visualizador */
  #exportArea{position:relative}
  .wm{position:absolute;inset:0;pointer-events:none;display:none}
  .wm.show::before{
    content:attr(data-text);position:absolute;top:50%;left:50%;
    transform:translate(-50%,-50%) rotate(-16deg);
    font:700 64px/1 Poppins,system-ui;color:#0b2a5a;opacity:.08;white-space:nowrap
  }
  .headerRow{display:flex;justify-content:space-between;align-items:center;gap:12px}
  #hdr-title{font:700 32px/1.1 Poppins,-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,system-ui}

  /* Logo M dentro de la tarjeta */
  .logoCard{width:36px;height:36px;border:1px solid var(--border);border-radius:10px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .logoCard img{max-width:100%;max-height:100%;object-fit:contain;display:block}

  .itins{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
  .itinCol{border:1px solid var(--border);border-radius:14px;padding:12px;min-height:300px}
  .itinOld{background:linear-gradient(180deg,var(--oldA),var(--oldB));border-color:var(--oldBorder)}
  .itinNew{background:linear-gradient(180deg,var(--newA),var(--newB));border-color:var(--newBorder)}
  .leg{border:1px dashed var(--border);border-radius:12px;padding:10px;background:#ffffffc8;margin-top:10px}
  .legHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
  .codes{font-weight:700;font-size:18px}
  .airLogoBox{height:42px;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;min-width:120px}
  .airLogoBox img{max-height:100%;width:auto;display:block}
  .meta{font-size:12px;color:#475569;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:3px 8px;font-size:11px;color:#334155}
  #locBadges .badge{font-size:13px;padding:5px 10px}

  .times{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .times.stop{grid-template-columns:repeat(4,1fr)}
  .big{font-weight:700;font-size:18px}

  .prices{display:grid;grid-template-columns:repeat(4,1fr) 1.2fr;gap:12px;margin-top:14px}
  .pill{border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center;background:var(--muted)}
  .pill .v{font-weight:700}
  .totalPill{background:linear-gradient(135deg,#e7f3ff,#ecfbff);border-color:#93c5fd}
  .totalPill .v{font-size:22px}
  .notes{margin-top:12px;border:1px dashed var(--border);border-radius:12px;background:#fff;padding:10px;min-height:60px}
  .foot{display:flex;justify-content:space-between;gap:12px;margin-top:12px;color:#64748b;font-size:12px;align-items:center}

  .hotelBox{display:none;align-items:center;justify-content:space-between;gap:10px;margin-top:10px;border:1px dashed var(--border);border-radius:12px;padding:10px;background:#ffffffc8}
  .hotelLogo{width:56px;height:56px;border:1px solid var(--border);border-radius:14px;background:#fff;display:grid;place-items:center;overflow:hidden}
  .hotelLogo img{max-width:100%;max-height:100%;object-fit:contain}

  /* PRINT: 1 sola página A4 landscape */
  @media print{
    .bar,.sep,#panel,.btnPdfHide{display:none!important}
    *{-webkit-print-color-adjust:exact; print-color-adjust:exact}
    @page{size:A4 landscape;margin:8mm}
    html,body{height:auto}
    .wrap{padding:0}
    body{font-size:12px}
    #hdr-title{font-size:26px}
    .codes{font-size:16px}
    .big{font-size:16px}
    .logoCard{width:28px;height:28px}
    .notes{min-height:40px}
    #exportArea{transform:scale(0.92);transform-origin:top left}
  }

  #err{display:none;background:#fff4f4;border:1px solid #fecaca;color:#7f1d1d;padding:8px;border-radius:10px;margin:10px 0;font-size:13px}
</style>
</head>
<body>
  <!-- Barra superior -->
  <div class="bar">
    <div class="barInner">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="logoBoxTiny">
          <img id="maarlabLogoMTop" alt="M" crossorigin="anonymous" referrerpolicy="no-referrer"
               src="https://cdn.theorg.com/5a5ab266-2e99-4c2f-9c04-fe46304ee4fc_thumb.jpg">
        </div>
        <div class="brandTitle">Operations Maarlab</div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <label class="tiny" style="display:flex;align-items:center;gap:6px">
          <span id="langLbl">Idioma</span>
          <select id="langSelect">
            <option value="es" selected>ES</option><option value="en">EN</option>
            <option value="fr">FR</option><option value="it">IT</option><option value="de">DE</option>
          </select>
        </label>
        <div class="chip" id="chipMode" title="Modo de la tarjeta">
          <button data-mode="quote" class="active">Cotización</button>
          <button data-mode="confirm">Confirmación</button>
        </div>
        <div class="chip" id="chipCurrency">
          <button data-cur="EUR" class="active">EUR</button>
          <button data-cur="USD">USD</button>
          <button data-cur="MXN">MXN</button>
        </div>
        <button id="btnPdfTop" class="btn">PDF</button>
      </div>
    </div>
    <div class="sep"></div>
  </div>

  <main class="wrap grid2">
    <!-- ===== Visualizador (izquierda) ===== -->
    <section class="card" id="cardWrap">
      <div id="err"></div>
      <div id="exportArea">
        <div class="wm" id="wm" data-text=""></div>
        <div class="headerRow">
          <div>
            <div class="tiny" id="hdr-sub">Modificación de reserva · Round Trip</div>
            <div id="hdr-title">Modificación de reserva</div>
            <div class="tiny" id="hdr-dates">Ida: — → — · Vuelta: — → —</div>
            <div class="badges" id="locBadges"></div>
            <div class="badges"><span class="badge" id="modeBadge">Cotización</span></div>
          </div>
          <!-- Logo M en la tarjeta -->
          <div class="logoCard">
            <img id="maarlabLogoMCard" alt="M" crossorigin="anonymous" referrerpolicy="no-referrer"
                 src="https://cdn.theorg.com/5a5ab266-2e99-4c2f-9c04-fe46304ee4fc_thumb.jpg">
          </div>
        </div>

        <div class="itins">
          <!-- Anteriores -->
          <div class="itinCol itinOld">
            <div style="font:700 14px Poppins,system-ui" id="prevTitle">Vuelos anteriores</div>

            <div class="leg" id="leg-oo">
              <div class="legHead">
                <div>
                  <div class="codes" id="ooCodes">XXX → XXX</div>
                  <div class="tiny" id="ooCities">— → —</div>
                </div>
                <div class="airLogoBox"><img id="logo-oo" alt="air-oo" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta"><span id="ooMeta">Vuelo — Fecha</span><div class="badges" id="ooBadges"></div></div>
              <div class="times" id="ooTimes"></div>
            </div>

            <div class="leg" id="leg-or">
              <div class="legHead">
                <div>
                  <div class="codes" id="orCodes">XXX → XXX</div>
                  <div class="tiny" id="orCities">— → —</div>
                </div>
                <div class="airLogoBox"><img id="logo-or" alt="air-or" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta"><span id="orMeta">Vuelo — Fecha</span><div class="badges" id="orBadges"></div></div>
              <div class="times" id="orTimes"></div>
            </div>
          </div>

          <!-- Nuevos (rutas independientes) -->
          <div class="itinCol itinNew">
            <div style="font:700 14px Poppins,system-ui" id="newTitle">Vuelos nuevos</div>

            <div class="leg" id="leg-no">
              <div class="legHead">
                <div>
                  <div class="codes" id="noCodes">XXX → XXX</div>
                  <div class="tiny" id="noCities">— → —</div>
                </div>
                <div class="airLogoBox"><img id="logo-no" alt="air-no" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta"><span id="noMeta">Vuelo — Fecha</span><div class="badges" id="noBadges"></div></div>
              <div class="times" id="noTimes"></div>
            </div>

            <div class="leg" id="leg-nr">
              <div class="legHead">
                <div>
                  <div class="codes" id="nrCodes">XXX → XXX</div>
                  <div class="tiny" id="nrCities">— → —</div>
                </div>
                <div class="airLogoBox"><img id="logo-nr" alt="air-nr" crossorigin="anonymous" referrerpolicy="no-referrer"></div>
              </div>
              <div class="meta"><span id="nrMeta">Vuelo — Fecha</span><div class="badges" id="nrBadges"></div></div>
              <div class="times" id="nrTimes"></div>
            </div>
          </div>
        </div>

        <!-- Hotel opcional -->
        <div class="hotelBox" id="hotelBox">
          <div>
            <div class="tiny" id="hotelCaption">Hotel</div>
            <div class="big" id="hotelName">—</div>
          </div>
          <div class="hotelLogo"><img id="hotelLogoImg" alt="hotel-logo"></div>
        </div>

        <!-- Precios -->
        <div class="prices">
          <div class="pill"><div class="tiny" id="penLabel">Penalización</div><div class="v" id="penVal">€0,00</div></div>
          <div class="pill"><div class="tiny" id="feeLabel">Fee servicio</div><div class="v" id="feeVal">€0,00</div></div>
          <div class="pill"><div class="tiny" id="fareLabel">Diferencia de tarifa</div><div class="v" id="fareVal">€0,00</div></div>
          <div class="pill"><div class="tiny" id="ppLabel">Total por pax</div><div class="v" id="ppVal">€0,00</div></div>
          <div class="pill totalPill"><div class="tiny" id="totLabel">Total a pagar</div><div class="v" id="totVal">€0,00</div></div>
        </div>

        <!-- Notas -->
        <div class="notes" contenteditable="true" id="notesBox">Notas / Notes…</div>
      </div>

      <div class="foot">
        <div class="tiny" id="footerText">Generado por Maarlab · Contacto: booking@maarlab.com</div>
        <div class="btnPdfHide" style="display:flex;gap:8px">
          <button id="btnPdf" class="btn">PDF</button>
        </div>
      </div>
    </section>

    <!-- ===== Formulario (derecha) ===== -->
    <aside class="card" id="panel">
      <h2 id="hOut">Ruta (ida) — original</h2>
      <div class="row">
        <label>Origen (IATA) <input id="outFrom" list="iataList" placeholder="TFN" data-iata="outFromCity"></label>
        <label>Ciudad origen <input id="outFromCity" placeholder="Tenerife Norte"></label>
        <label>Destino (IATA) <input id="outTo" list="iataList" placeholder="MAD" data-iata="outToCity"></label>
        <label>Ciudad destino <input id="outToCity" placeholder="Madrid"></label>
      </div>

      <h2 id="hRet" style="margin-top:12px">Ruta (vuelta) — original</h2>
      <div class="row">
        <label>Origen (IATA) <input id="retFrom" list="iataList" placeholder="MAD" data-iata="retFromCity"></label>
        <label>Ciudad origen <input id="retFromCity" placeholder="Madrid"></label>
        <label>Destino (IATA) <input id="retTo" list="iataList" placeholder="TFN" data-iata="retToCity"></label>
        <label>Ciudad destino <input id="retToCity" placeholder="Tenerife Norte"></label>
      </div>

      <h2 style="margin-top:14px">Ruta (ida) — NUEVA</h2>
      <div class="row">
        <label>Origen (IATA) <input id="newOutFrom" list="iataList" placeholder="(ej. TFS)" data-iata="newOutFromCity"></label>
        <label>Ciudad origen <input id="newOutFromCity" placeholder=""></label>
        <label>Destino (IATA) <input id="newOutTo" list="iataList" placeholder="(ej. LPA)" data-iata="newOutToCity"></label>
        <label>Ciudad destino <input id="newOutToCity" placeholder=""></label>
      </div>

      <h2 style="margin-top:12px">Ruta (vuelta) — NUEVA</h2>
      <div class="row">
        <label>Origen (IATA) <input id="newRetFrom" list="iataList" placeholder="(ej. BIO)" data-iata="newRetFromCity"></label>
        <label>Ciudad origen <input id="newRetFromCity" placeholder=""></label>
        <label>Destino (IATA) <input id="newRetTo" list="iataList" placeholder="(ej. HEL)" data-iata="newRetToCity"></label>
        <label>Ciudad destino <input id="newRetToCity" placeholder=""></label>
      </div>

      <h2 style="margin-top:14px">Vuelos anteriores</h2>
      <div class="row">
        <label>Ida — Aerolínea (código) <input id="ooAir" list="airlineCodes" placeholder="IB" maxlength="3"></label>
        <label>Ida — N.º vuelo <input id="ooNum" placeholder="3478"></label>
        <label>Ida — Salida <input id="ooDep" placeholder="10:30"></label>
        <label>Ida — Llegada <input id="ooArr" placeholder="12:50"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Vuelta — Aerolínea (código) <input id="orAir" list="airlineCodes" placeholder="IB" maxlength="3"></label>
        <label>Vuelta — N.º vuelo <input id="orNum" placeholder="3479"></label>
        <label>Vuelta — Salida <input id="orDep" placeholder="17:20"></label>
        <label>Vuelta — Llegada <input id="orArr" placeholder="19:35"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Ida — Fecha <input id="ooDate" type="date"></label>
        <label>Vuelta — Fecha <input id="orDate" type="date"></label>
      </div>

      <h2 style="margin-top:14px">Vuelos nuevos</h2>
      <div class="row">
        <label>Ida — Aerolínea (código) <input id="noAir" list="airlineCodes" placeholder="UX" maxlength="3"></label>
        <label>Ida — N.º vuelo <input id="noNum" placeholder="1234"></label>
        <label>Ida — Salida <input id="noDep" placeholder="11:15"></label>
        <label>Ida — Llegada <input id="noArr" placeholder="13:40"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Vuelta — Aerolínea (código) <input id="nrAir" list="airlineCodes" placeholder="UX" maxlength="3"></label>
        <label>Vuelta — N.º vuelo <input id="nrNum" placeholder="1235"></label>
        <label>Vuelta — Salida <input id="nrDep" placeholder="18:10"></label>
        <label>Vuelta — Llegada <input id="nrArr" placeholder="20:30"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Ida — Fecha <input id="noDate" type="date"></label>
        <label>Vuelta — Fecha <input id="nrDate" type="date"></label>
      </div>

      <details style="margin-top:8px">
        <summary>Escalas (opcionales)</summary>
        <div class="row" style="margin-top:8px">
          <label>Old Out — Stop (IATA) <input id="ooStop" list="iataList" placeholder="BCN"></label>
          <label>Arrive stop (HH:MM) <input id="ooStopArr" placeholder="11:20"></label>
          <label>Depart stop (HH:MM) <input id="ooStopDep" placeholder="12:05"></label>
          <div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <label>Old Ret — Stop (IATA) <input id="orStop" list="iataList" placeholder="BCN"></label>
          <label>Arrive stop (HH:MM) <input id="orStopArr" placeholder="18:05"></label>
          <label>Depart stop (HH:MM) <input id="orStopDep" placeholder="18:50"></label>
          <div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <label>New Out — Stop (IATA) <input id="noStop" list="iataList" placeholder="BCN"></label>
          <label>Arrive stop (HH:MM) <input id="noStopArr" placeholder="12:00"></label>
          <label>Depart stop (HH:MM) <input id="noStopDep" placeholder="12:45"></label>
          <div></div>
        </div>
        <div class="row" style="margin-top:6px">
          <label>New Ret — Stop (IATA) <input id="nrStop" list="iataList" placeholder="BCN"></label>
          <label>Arrive stop (HH:MM) <input id="nrStopArr" placeholder="21:00"></label>
          <label>Depart stop (HH:MM) <input id="nrStopDep" placeholder="21:40"></label>
          <div></div>
        </div>
      </details>

      <h2 style="margin-top:14px">Hotel (opcional)</h2>
      <div class="row">
        <label>Nombre de hotel <input id="hotelNameInput" placeholder="Spring Arona Gran"></label>
        <label>Logo del hotel (archivo) <input id="hotelLogoFile" type="file" accept="image/*"></label>
      </div>

      <h2 style="margin-top:14px">Localizadores (opcional)</h2>
      <div class="row">
        <label>Localizador reserva <input id="bookingRef" placeholder="ABC123"></label>
        <label>Localizador Maarlab <input id="maarlabRef" placeholder="MLB-0001"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Localizador hotel <input id="hotelRef" placeholder="cualquier formato"></label>
        <div></div>
      </div>

      <h2 style="margin-top:14px">Costes</h2>
      <div class="row-3">
        <label>Penalización <input id="penalty" placeholder="150,00"></label>
        <label>Fee servicio <input id="fee" placeholder="30,00"></label>
        <label>Diferencia de tarifa <input id="fareDiff" placeholder="45,50"></label>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Pax <input id="pax" type="number" min="1" step="1" value="1"></label>
        <div></div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap">
        <div style="flex:1"></div>
        <button id="btnPdf2" class="btn">PDF</button>
      </div>

      <details style="margin-top:12px">
        <summary>Opciones avanzadas</summary>
        <div class="row" style="margin-top:8px">
          <label>Logos aerolíneas (base URL) <input id="airlineBase"></label>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="fxEnable" checked> <span>Convertir desde EUR</span>
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <label>1 EUR = USD <input id="fxUSD" value="1.08"></label>
          <label>1 EUR = MXN <input id="fxMXN" value="19.00"></label>
        </div>

        <!-- NUEVO: Conexión a tu backend de aeropuertos -->
        <div class="row" style="margin-top:8px">
          <label>Airports API (base URL)
            <input id="airportsBase" placeholder="https://api.maarlab.com/v1/catalog/airports">
          </label>
          <label>Airports API Key (opcional)
            <input id="airportsKey" placeholder="Bearer xxx...">
          </label>
        </div>
      </details>
    </aside>
  </main>

  <datalist id="airlineCodes"></datalist>
  <datalist id="iataList"></datalist>

<script>
(function(){
  var $ = function(id){ return document.getElementById(id); };

  /* ===== i18n (sin duración) ===== */
  var STR = {
    es:{hdrSub:"Modificación de reserva · Round Trip",hdrTitle:"Modificación de reserva",
        prev:"Vuelos anteriores",next:"Vuelos nuevos",
        dep:"Salida",arr:"Llegada",arrStop:"Llegada escala",depStop:"Salida escala",
        footer:"Generado por Maarlab · Contacto: booking@maarlab.com",
        badgeMode:{quote:"Cotización",confirm:"Confirmación"}},
    en:{hdrSub:"Reservation change · Round Trip",hdrTitle:"Reservation change",
        prev:"Previous flights",next:"New flights",
        dep:"Departure",arr:"Arrival",arrStop:"Arrive stop",depStop:"Depart stop",
        footer:"Generated by Maarlab · Contact: booking@maarlab.com",
        badgeMode:{quote:"Quotation",confirm:"Confirmation"}},
    fr:{hdrSub:"Modification de réservation · AR",hdrTitle:"Modification de réservation",
        prev:"Vols précédents",next:"Nouveaux vols",
        dep:"Départ",arr:"Arrivée",arrStop:"Arrivée escale",depStop:"Départ escale",
        footer:"Généré par Maarlab · Contact : booking@maarlab.com",
        badgeMode:{quote:"Devis",confirm:"Confirmation"}},
    it:{hdrSub:"Modifica prenotazione · A/R",hdrTitle:"Modifica prenotazione",
        prev:"Voli precedenti",next:"Nuovi voli",
        dep:"Partenza",arr:"Arrivo",arrStop:"Arrivo scalo",depStop:"Partenza scalo",
        footer:"Generato da Maarlab · Contatto: booking@maarlab.com",
        badgeMode:{quote:"Preventivo",confirm:"Conferma"}},
    de:{hdrSub:"Reservierungsänderung · RT",hdrTitle:"Reservierungsänderung",
        prev:"Bisherige Flüge",next:"Neue Flüge",
        dep:"Abflug",arr:"Ankunft",arrStop:"Ankunft Zwischenstopp",depStop:"Abflug Zwischenstopp",
        footer:"Erstellt von Maarlab · Kontakt: booking@maarlab.com",
        badgeMode:{quote:"Angebot",confirm:"Bestätigung"}}
  };
  var LANG="es", CUR="EUR";
  var MODE = "quote"; // "quote" | "confirm"

  /* ===== datos ===== */
  var DEFAULT_AIRLINE_BASE = "https://maarlabcdnstorage.blob.core.windows.net/web-assets/images/airlines";
  var DEFAULT_MAARLAB_MARK = "https://cdn.theorg.com/5a5ab266-2e99-4c2f-9c04-fe46304ee4fc_thumb.jpg";

  /* NUEVO: base de aeropuertos remota por defecto (ajústala a tu API) */
  var DEFAULT_AIRPORTS_BASE = "https://api.maarlab.com/v1/catalog/airports";

  /* Aerolíneas (incluye fallback F8→F9 y U→U2) */
  var AIRLINES = {
    "U":"easyJet","U2":"easyJet",
    "AM":"Aeroméxico","Y4":"Volaris","VB":"VivaAerobus","LA":"LATAM","AR":"Aerolíneas Argentinas","CM":"Copa Airlines",
    "AV":"Avianca","G3":"GOL","H2":"Sky Airline",
    "IB":"Iberia","I2":"Iberia Express","VY":"Vueling","UX":"Air Europa","NT":"Binter Canarias","FR":"Ryanair",
    "W6":"Wizz Air","W4":"Wizz Air Malta","TO":"Transavia France","HV":"Transavia","BA":"British Airways",
    "KL":"KLM","AF":"Air France","LH":"Lufthansa","LX":"SWISS","OS":"Austrian","SN":"Brussels Airlines","LO":"LOT",
    "DY":"Norwegian","EW":"Eurowings","A3":"Aegean","TK":"Turkish Airlines","PC":"Pegasus",
    "F8":"Frontier","F9":"Frontier","AA":"American Airlines","UA":"United","DL":"Delta","B6":"JetBlue","WN":"Southwest","NK":"Spirit",
    "AS":"Alaska","AC":"Air Canada","WS":"WestJet","EI":"Aer Lingus","LS":"Jet2"
  };
  var LOGO_FALLBACK = {"F8":"F9","U":"U2"};

  /* IATA → ciudad (solo en RAM, sin persistencia) */
  var IATA_DB = {}; var IATA_READY = false;

  var hotelLogoData = "";

  function nf(cur,lang){
    var loc = lang==="en"?"en-US":lang==="fr"?"fr-FR":lang==="it"?"it-IT":lang==="de"?"de-DE":"es-ES";
    return new Intl.NumberFormat(loc,{style:"currency",currency:cur,minimumFractionDigits:2,maximumFractionDigits:2});
  }
  function parseMoney(s){ var t=String(s||"").replace(/\./g,"").replace(",","."); var n=parseFloat(t); return isFinite(n)?n:0; }
  function normalizeCode(c){ return String(c||"").toUpperCase().trim(); }
  function airlineLogoUrl(code){
    var base = ($("airlineBase") && $("airlineBase").value) ? $("airlineBase").value : DEFAULT_AIRLINE_BASE;
    return base.replace(/\/$/,"") + "/" + code + ".png";
  }
  function fmtDate(d){ if(!d) return "—"; var p=String(d).split("-"); if(p.length!==3) return d; return p[2]+"/"+p[1]+"/"+p[0]; }
  function dayOfWeekNative(dateISO){
    if(!dateISO) return "";
    var loc = {es:"es-ES",en:"en-US",fr:"fr-FR",it:"it-IT",de:"de-DE"}[LANG] || "es-ES";
    try{ return new Date(dateISO+"T00:00:00").toLocaleDateString(loc,{weekday:"long"}); }catch(e){ return ""; }
  }
  var HM_RE = /^([01]\d|2[0-3]):[0-5]\d$/;

  function setLegLogo(imgId, code){
    var img=$(imgId); if(!img) return;
    var raw=normalizeCode(code);
    if(!raw){ img.style.visibility="hidden"; img.removeAttribute("src"); return; }
    var fallback = LOGO_FALLBACK[raw] ? normalizeCode(LOGO_FALLBACK[raw]) : "";
    img.style.visibility="visible"; img.onerror=null;
    img.onerror=function(){
      if(fallback && img.getAttribute("data-fb")!=="1"){
        img.setAttribute("data-fb","1"); img.src=airlineLogoUrl(fallback);
      }else{ img.style.visibility="hidden"; img.removeAttribute("src"); }
    };
    img.crossOrigin="anonymous"; img.referrerPolicy="no-referrer";
    img.removeAttribute("data-fb");
    img.src=airlineLogoUrl(raw);
  }

  function renderLeg(prefix, fromIata, toIata, cityFrom, cityTo){
    var S=STR[LANG];
    var code=normalizeCode($(prefix+"Air").value);
    var num =(($(prefix+"Num").value)||"").toUpperCase();
    var dateISO = (prefix==="oo"||prefix==="or") ? ($(prefix==="oo"?"ooDate":"orDate").value) : ($(prefix==="no"?"noDate":"nrDate").value);
    var dow = dayOfWeekNative(dateISO);
    var stop=normalizeCode((($(prefix+"Stop")||{}).value)||"");
    var stopArr=(($(prefix+"StopArr")||{}).value)||"";
    var stopDep=(($(prefix+"StopDep")||{}).value)||"";

    $(prefix+"Codes").textContent = (fromIata||"XXX")+" → "+(toIata||"XXX");
    $(prefix+"Cities").textContent = (cityFrom||"—")+" → "+(cityTo||"—");
    var dateTxt = dateISO? (dow+" "+fmtDate(dateISO)) : "—";
    $(prefix+"Meta").textContent = (code||"")+(num||"")+" · "+(AIRLINES[code]||"—")+" · "+dateTxt;

    setLegLogo("logo-"+prefix, code);

    var $b=$(prefix+"Badges"); if($b) $b.innerHTML="";

    var $t=$(prefix+"Times"); $t.innerHTML="";
    function cell(lbl,val){ var w=document.createElement("div"); var l=document.createElement("div"); l.className="tiny"; l.textContent=lbl; var v=document.createElement("div"); v.className="big"; v.textContent=val||"--:--"; w.appendChild(l); w.appendChild(v); return w; }
    var depHM=$(prefix+"Dep").value, arrHM=$(prefix+"Arr").value;
    if(stop && HM_RE.test(stopArr||"") && HM_RE.test(stopDep||"")){
      $t.classList.add("stop");
      $t.appendChild(cell(S.dep,depHM));
      $t.appendChild(cell(S.arrStop,stopArr));
      $t.appendChild(cell(S.depStop,stopDep));
      $t.appendChild(cell(S.arr,arrHM));
    }else{
      $t.classList.remove("stop");
      $t.appendChild(cell(S.dep,depHM));
      $t.appendChild(cell(S.arr,arrHM));
    }
  }

  function moneyOut(v){
    var fxOn = $("fxEnable") && $("fxEnable").checked;
    if(CUR==="EUR") return nf("EUR",LANG).format(v);
    if(!fxOn) return nf(CUR,LANG).format(v);
    var usd = Number(($("fxUSD")&&$("fxUSD").value)||1.08);
    var mxn = Number(($("fxMXN")&&$("fxMXN").value)||19.0);
    if(CUR==="USD") return nf("USD",LANG).format(v*usd);
    if(CUR==="MXN") return nf("MXN",LANG).format(v*mxn);
    return nf(CUR,LANG).format(v);
  }

  function applyI18n(){
    var S = STR[LANG];
    $("hdr-title").textContent = (MODE === "confirm") ? {es:"Confirmación de cambio",en:"Change confirmation",fr:"Confirmation de changement",it:"Conferma di cambio",de:"Änderungsbestätigung"}[LANG] : S.hdrTitle;
    $("hdr-sub").textContent   = S.hdrSub;
    $("prevTitle").textContent = S.prev;
    $("newTitle").textContent  = S.next;
    $("footerText").textContent= S.footer;
    $("langLbl").textContent = LANG==="en"?"Language":LANG==="fr"?"Langue":LANG==="it"?"Lingua":LANG==="de"?"Sprache":"Idioma";
    var badgeText = (MODE==="confirm") ? S.badgeMode.confirm : S.badgeMode.quote;
    if ($("modeBadge")) $("modeBadge").textContent = badgeText;
    $("totLabel").textContent = (MODE==="confirm") ? {es:"Total pagado",en:"Total paid",fr:"Total payé",it:"Totale pagato",de:"Gesamt bezahlt"}[LANG] : {es:"Total a pagar",en:"Total due",fr:"Total à payer",it:"Totale da pagare",de:"Gesamt fällig"}[LANG];
    var wm = $("wm"); if(wm){ wm.dataset.text = (MODE==="confirm") ? ({es:"CONFIRMADO",en:"CONFIRMED",fr:"CONFIRMÉ",it:"CONFERMATO",de:"BESTÄTIGT"}[LANG]||"CONFIRMADO") : ""; wm.classList.toggle("show", MODE==="confirm"); }
    refresh();
  }

  function refresh(){
    try{
      // Rutas originales
      var outFrom=normalizeCode(($("outFrom").value)||"XXX"), outTo=normalizeCode(($("outTo").value)||"XXX");
      var retFrom=normalizeCode(($("retFrom").value)||"XXX"), retTo=normalizeCode(($("retTo").value)||"XXX");
      var outFromCity=($("outFromCity").value)||"—", outToCity=($("outToCity").value)||"—";
      var retFromCity=($("retFromCity").value)||"—", retToCity=($("retToCity").value)||"—";

      // Rutas NUEVAS (independientes; fallback a las originales si vacío)
      var newOutFrom=normalizeCode(($("newOutFrom").value)||"") || outFrom;
      var newOutTo  =normalizeCode(($("newOutTo").value)||"")   || outTo;
      var newRetFrom=normalizeCode(($("newRetFrom").value)||"") || retFrom;
      var newRetTo  =normalizeCode(($("newRetTo").value)||"")   || retTo;

      var newOutFromCity = ($("newOutFromCity").value)|| outFromCity;
      var newOutToCity   = ($("newOutToCity").value)|| outToCity;
      var newRetFromCity = ($("newRetFromCity").value)|| retFromCity;
      var newRetToCity   = ($("newRetToCity").value)|| retToCity;

      // Fechas con día de semana
      var ood=fmtDate(($("ooDate").value)||""), ord=fmtDate(($("orDate").value)||""), nod=fmtDate(($("noDate").value)||""), nrd=fmtDate(($("nrDate").value)||"");
      var oodD=dayOfWeekNative(($("ooDate").value)||""), ordD=dayOfWeekNative(($("orDate").value)||""), nodD=dayOfWeekNative(($("noDate").value)||""), nrdD=dayOfWeekNative(($("nrDate").value)||"");
      $("hdr-dates").textContent = "Ida: "+(oodD?oodD+" ":"")+ood+" → "+(nodD?nodD+" ":"")+nod+" · Vuelta: "+(ordD?ordD+" ":"")+ord+" → "+(nrdD?nrdD+" ":"")+nrd;

      // Render
      renderLeg("oo", outFrom, outTo, outFromCity, outToCity);
      renderLeg("or", retFrom, retTo, retFromCity, retToCity);
      renderLeg("no", newOutFrom, newOutTo, newOutFromCity, newOutToCity);
      renderLeg("nr", newRetFrom, newRetTo, newRetFromCity, newRetToCity);

      // Precios
      var p=parseMoney(($("penalty").value)||0), f=parseMoney(($("fee").value)||0), d=parseMoney(($("fareDiff").value)||0);
      var pax = Math.max(1, parseInt((($("pax").value)||"1"),10)||1);
      $("penVal").textContent=moneyOut(p);
      $("feeVal").textContent=moneyOut(f);
      $("fareVal").textContent=moneyOut(d);
      $("ppVal").textContent=moneyOut(p+f+d);
      $("totVal").textContent=moneyOut((p+f+d)*pax);

      // Badges de localizadores
      var c=$("locBadges"); c.innerHTML="";
      var locs=(($("bookingRef").value)||"").trim(); if(locs){ var b=document.createElement("span"); b.className="badge"; b.textContent="PNR: "+locs; c.appendChild(b); }
      var ml=(($("maarlabRef").value)||"").trim(); if(ml){ var b2=document.createElement("span"); b2.className="badge"; b2.textContent="Maarlab: "+ml; c.appendChild(b2); }
      var hr=(($("hotelRef").value)||"").trim(); if(hr){ var b3=document.createElement("span"); b3.className="badge"; b3.textContent="Hotel: "+hr; c.appendChild(b3); }

      // Hotel
      var hname=(($("hotelNameInput").value)||"").trim();
      $("hotelName").textContent = hname || "—";
      $("hotelBox").style.display = (hname || hotelLogoData) ? "flex" : "none";
      if(hotelLogoData){ $("hotelLogoImg").src = hotelLogoData; $("hotelLogoImg").style.display="block"; }
      else { $("hotelLogoImg").removeAttribute("src"); $("hotelLogoImg").style.display="none"; }
    }catch(e){
      console.error(e);
      if ($("err")){ $("err").textContent="⚠️ Error: "+e.message; $("err").style.display="block"; setTimeout(function(){ $("err").style.display="none"; },4000); }
    }
  }

  function populateAirlineDatalist(){
    var dlAir=$("airlineCodes"); if(!dlAir) return;
    dlAir.innerHTML="";
    Object.keys(AIRLINES).forEach(function(k){
      var o=document.createElement("option"); o.value=k; o.label=AIRLINES[k]; dlAir.appendChild(o);
    });
  }

  function populateIataDatalist(){
    var dlI=$("iataList"); if(!dlI) return;
    dlI.innerHTML="";
    Object.keys(IATA_DB).forEach(function(k){
      var o=document.createElement("option"); o.value=k; o.label=IATA_DB[k]; dlI.appendChild(o);
    });
  }

  // ======= Conexión con tu backend de aeropuertos (sin caché persistente) =======
  function getAirportsBase(){
    var base = ($("airportsBase") && $("airportsBase").value) ? $("airportsBase").value : DEFAULT_AIRPORTS_BASE;
    return (base||"").replace(/\/$/,"");
  }
  function getAirportsHeaders(){
    var key = ($("airportsKey") && $("airportsKey").value) ? $("airportsKey").value.trim() : "";
    var h = {"Accept":"application/json","Cache-Control":"no-store"};
    if(key){ h["Authorization"] = key.startsWith("Bearer ") ? key : ("Bearer "+key); }
    return h;
  }

  // Normaliza cualquier respuesta a { IATA: "Ciudad" }
  function normalizeAirportsPayload(payload){
    var map = {};
    if(Array.isArray(payload)){
      payload.forEach(function(a){
        var code = normalizeCode(a.iata || a.code || a.IATA || a.Code);
        var city = a.city || a.City || a.municipality || a.name || a.label || "";
        if(code && city) map[code]=city;
      });
    }else if(payload && typeof payload === "object"){
      // Puede venir ya como {MAD:"Madrid", ...} o como { items:[...] }
      if(payload.items && Array.isArray(payload.items)){
        payload.items.forEach(function(a){
          var code = normalizeCode(a.iata || a.code || a.IATA || a.Code);
          var city = a.city || a.City || a.municipality || a.name || a.label || "";
          if(code && city) map[code]=city;
        });
      }else{
        Object.keys(payload).forEach(function(k){
          var code = normalizeCode(k);
          var city = payload[k];
          if(code && city) map[code]=String(city);
        });
      }
    }
    return map;
  }

  // Carga catálogo (sin cache persistente; cache busting en URL y cache:no-store)
  function loadIataDb(){
    var base = getAirportsBase();
    if(!base){ IATA_DB={}; IATA_READY=false; populateIataDatalist(); refresh(); return; }

    var url = base + (base.includes("?") ? "&" : "?") + "_ts=" + Date.now();
    fetch(url, {method:"GET", headers:getAirportsHeaders(), cache:"no-store"})
      .then(function(r){ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
      .then(function(payload){
        IATA_DB = normalizeAirportsPayload(payload) || {};
        IATA_READY = Object.keys(IATA_DB).length>0;
        populateIataDatalist();
        refresh();
      })
      .catch(function(err){
        console.warn("No se pudo cargar Airports API:", err);
        // Fallback mínimo para no romper UX (sin persistir)
        IATA_DB = {
          "MAD":"Madrid","BCN":"Barcelona","AGP":"Málaga","VLC":"Valencia","SVQ":"Sevilla",
          "PMI":"Palma de Mallorca","IBZ":"Ibiza","ALC":"Alicante",
          "TFN":"Tenerife Norte","TFS":"Tenerife Sur","LPA":"Las Palmas (Gran Canaria)","SPC":"La Palma","BIO":"Bilbao",
          "LIS":"Lisboa","CDG":"París (Charles de Gaulle)","ORY":"París (Orly)","FRA":"Fráncfort","AMS":"Ámsterdam",
          "HEL":"Helsinki","LHR":"Londres (Heathrow)","LGW":"Londres (Gatwick)","LTN":"Luton","STN":"Stansted","EMA":"East Midlands","LPL":"Liverpool",
          "MEX":"Ciudad de México","NLU":"Felipe Ángeles (CDMX)","GDL":"Guadalajara","MTY":"Monterrey",
          "CUN":"Cancún","TQO":"Tulum (Felipe Carrillo Puerto)","CZM":"Cozumel","HUX":"Huatulco","PVR":"Puerto Vallarta","ACA":"Acapulco",
          "DFW":"Dallas/Fort Worth","EWR":"Newark","JFK":"Nueva York (JFK)","LAX":"Los Ángeles","SFO":"San Francisco"
        };
        IATA_READY = true;
        populateIataDatalist();
        refresh();
      });
  }

  // Lookup puntual por código si el catálogo cargado no lo trae
  function lookupAirportByCode(code){
    var base = getAirportsBase();
    if(!base || !code) return Promise.resolve(null);
    var url = base.replace(/\/$/,"") + "/" + encodeURIComponent(code) + "?_ts=" + Date.now();
    return fetch(url, {method:"GET", headers:getAirportsHeaders(), cache:"no-store"})
      .then(function(r){ if(!r.ok) return null; return r.json(); })
      .then(function(a){
        if(!a) return null;
        var city = a.city || a.City || a.municipality || a.name || a.label || "";
        return city ? { code: normalizeCode(a.iata || a.code || code), city: city } : null;
      })
      .catch(function(){ return null; });
  }

  function populateAirlineDatalist(){ // redefinida arriba, aquí solo aseguramos que existe
    var dlAir=$("airlineCodes"); if(!dlAir) return;
    dlAir.innerHTML="";
    Object.keys(AIRLINES).forEach(function(k){
      var o=document.createElement("option"); o.value=k; o.label=AIRLINES[k]; dlAir.appendChild(o);
    });
  }

  function bindAll(){
    // Cambios de inputs (realtime)
    var inputs = document.querySelectorAll("#panel input, #panel select");
    inputs.forEach(function(el){
      var handler = function(){
        // Uppercase en códigos/IATA
        if(/(From|To)$/.test(el.id) || /Stop|Air$/i.test(el.id)){
          el.value = (el.value||"").toUpperCase();
        }
        // Validación HH:MM
        if(/(Dep|Arr|StopArr|StopDep)$/i.test(el.id)){
          var ok = (!el.value) || /^([01]\d|2[0-3]):[0-5]\d$/.test(el.value);
          el.classList.toggle("invalid", !ok);
        }
        // Autocompletar ciudad desde IATA (consulta runtime si falta)
        var targetId = el.getAttribute("data-iata");
        if(targetId){
          var cityEl=$(targetId), c=(el.value||"").toUpperCase().trim();
          if(cityEl && c.length>=3){
            if(IATA_READY && IATA_DB[c]){
              cityEl.value = IATA_DB[c];
            }else{
              // lookup puntual sin persistencia
              lookupAirportByCode(c).then(function(res){
                if(res && cityEl && (($(el).value||"").toUpperCase().trim()===res.code)){
                  cityEl.value = res.city;
                }
              });
            }
          }
        }
        refresh();
      };
      el.addEventListener("input", handler);
      el.addEventListener("change", handler);
      el.addEventListener("keyup", handler);
    });

    // Logo hotel desde archivo
    if($("hotelLogoFile")){
      $("hotelLogoFile").addEventListener("change", function(e){
        var f = e.target.files && e.target.files[0];
        if(!f){ hotelLogoData=""; refresh(); return; }
        var r=new FileReader(); r.onload=function(){ hotelLogoData = r.result; refresh(); }; r.readAsDataURL(f);
      });
    }

    // Idioma
    if($("langSelect")){
      $("langSelect").addEventListener("change", function(){
        LANG = this.value || "es";
        applyI18n();
      });
    }

    // Moneda
    if($("chipCurrency")){
      $("chipCurrency").addEventListener("click", function(e){
        var b=e.target.closest("button"); if(!b) return;
        CUR = b.getAttribute("data-cur");
        Array.from($("chipCurrency").querySelectorAll("button")).forEach(function(x){ x.classList.toggle("active", x===b); });
        refresh();
      });
    }

    // Modo (Cotización/Confirmación)
    if ($("chipMode")) {
      $("chipMode").addEventListener("click", function(e){
        var b = e.target.closest("button"); if(!b) return;
        MODE = b.getAttribute("data-mode") || "quote";
        Array.from($("chipMode").querySelectorAll("button")).forEach(function(x){ x.classList.toggle("active", x===b); });
        applyI18n();
      });
    }

    // Botones PDF
    ["btnPdf","btnPdf2","btnPdfTop"].forEach(function(id){
      var el=$(id); if(!el) return;
      el.addEventListener("click", function(){ window.print(); });
    });

    // Defaults
    if($("airlineBase")) $("airlineBase").value = DEFAULT_AIRLINE_BASE;
    if($("maarlabLogoMTop")) $("maarlabLogoMTop").src = DEFAULT_MAARLAB_MARK;
    if($("maarlabLogoMCard")) $("maarlabLogoMCard").src = DEFAULT_MAARLAB_MARK;
    if($("airportsBase")) $("airportsBase").value = DEFAULT_AIRPORTS_BASE;

    populateAirlineDatalist();
  }

  // Exponer refresh si hace falta llamarlo tras carga externa
  window.renderCard = refresh;

  document.addEventListener("DOMContentLoaded", function(){
    try{
      bindAll();
      loadIataDb();   // ← carga desde tu backend (sin cache persistente)
      applyI18n();    // llama a refresh()
      refresh();
    }catch(e){
      console.error(e);
      if ($("err")){ $("err").textContent="⚠️ Error inicializando: "+e.message; $("err").style.display="block"; }
    }
  });
})();
</script>
</body>
</html>
